<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Track</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>

<style>
body {
  background:#121212;
  color:white;
  text-align:center;
}

.cover {
  width: min(90vw, 420px);
  border-radius:16px;
  margin-top:40px;
  box-shadow:0 10px 40px rgba(0,0,0,0.5);
}

#waveform {
  margin-top:40px;
}

.back {
  position:absolute;
  left:20px;
  top:20px;
}
</style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark px-3">
  <a href="index.html" class="btn btn-outline-light">
    ← All tracks
  </a>

  <span class="navbar-brand mx-auto"></span>

  <div style="width:80px;"></div>
</nav>

<div class="container">

  <img id="cover" class="cover">

  <h2 id="title" class="mt-4"></h2>
  <p id="artist" style="color:#aaa;"></p>

  <div id="waveform"></div>

  <button id="playBtn" class="btn btn-light mt-4">
    ▶ Play
  </button>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const trackFile = params.get("track");

if (!trackFile) {
  document.body.innerHTML = "No track specified";
}

// Waveform player
const wavesurfer = WaveSurfer.create({
  container: "#waveform",
  waveColor: "#555",
  progressColor: "#1db954",
  height: 120
});

const playBtn = document.getElementById("playBtn");

// Load metadata
fetch(trackFile)
  .then(r => r.arrayBuffer())
  .then(buffer => {

    jsmediatags.read(new Blob([buffer]), {
      onSuccess: tag => {

        const title = tag.tags.title || trackFile;
        const artist = tag.tags.artist || "Unknown Artist";

        document.getElementById("title").innerText = title;
        document.getElementById("artist").innerText = artist;

        // artwork
        if (tag.tags.picture) {
          const data = tag.tags.picture.data;
          const format = tag.tags.picture.format;

          let base64 = "";
          for (let i = 0; i < data.length; i++) {
            base64 += String.fromCharCode(data[i]);
          }

          document.getElementById("cover").src =
            `data:${format};base64,${btoa(base64)}`;
        }

        wavesurfer.load(trackFile);
      }
    });
  });

playBtn.addEventListener("click", () => {
  wavesurfer.playPause();

  playBtn.innerText =
    wavesurfer.isPlaying() ? "⏸ Pause" : "▶ Play";
});

wavesurfer.on("finish", () => {
  playBtn.innerText = "▶ Play";
});
</script>

</body>
</html>
