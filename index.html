<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:,">
<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- jsmediatags -->
<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>

<!-- WaveSurfer -->
<script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>

<style>
body {
  background: #121212;
  color: white;
}

.track-card {
  background: #1e1e1e;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
}

.track-card img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  background: #333;
}

.track-info {
  flex-grow: 1;
}

.track-title {
  font-weight: 600;
}

.track-artist {
  font-size: 0.9rem;
  color: #aaa;
}

#waveform {
  margin-top: 10px;
}

#miniPlayer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1e1e1e;
  padding: 15px;
  border-top: 1px solid #333;
  display: none;
}

.container {
  padding-bottom: 160px;
}
</style>
</head>
<body>

<div class="container py-4">
<h1 class="text-center mb-4">Tracks</h1>

<div id="trackList"></div>
</div>

<!-- Sticky Player -->
<div id="miniPlayer">
  <div class="d-flex align-items-center gap-3">
    <img id="miniArtwork" width="50" height="50" style="border-radius:8px;">
    <div>
      <div id="miniTitle"></div>
      <div id="miniArtist" style="font-size:0.85rem;color:#aaa;"></div>
    </div>
  </div>
  <div id="waveform"></div>
</div>

<script src="tracks.js"></script>

<script>
const musicFiles = window.musicFiles;

let currentTrack = null;
let currentButton = null;
let currentCard = null;

const trackList = document.getElementById("trackList");
const miniPlayer = document.getElementById("miniPlayer");
const miniTitle = document.getElementById("miniTitle");
const miniArtist = document.getElementById("miniArtist");
const miniArtwork = document.getElementById("miniArtwork");

let wavesurfer = WaveSurfer.create({
  container: '#waveform',
  waveColor: '#555',
  progressColor: '#1db954',
  height: 80
});

// Build UI automatically from metadata
musicFiles.forEach(file => {
  fetch(file)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      jsmediatags.read(new Blob([buffer]), {
        onSuccess: function(tag) {

          let title = tag.tags.title || file.split("/").pop();
          let artist = tag.tags.artist || "Unknown Artist";
          let imageUrl = "";

          if (tag.tags.picture) {
            let data = tag.tags.picture.data;
            let format = tag.tags.picture.format;
            let base64String = "";
            for (let i = 0; i < data.length; i++) {
              base64String += String.fromCharCode(data[i]);
            }
            imageUrl = `data:${format};base64,${window.btoa(base64String)}`;
          }

          createTrackCard(file, title, artist, imageUrl);
        },
        onError: function(error) {
          console.log("Metadata error:", error);
          createTrackCard(file, file.split("/").pop(), "Unknown Artist", "");
        }
      });
    });
});


function createTrackCard(file, title, artist, imageUrl) {

  let card = document.createElement("div");
  card.className = "track-card d-flex align-items-center";

  card.innerHTML = `
    <img src="${imageUrl || ''}">
    <div class="track-info ms-3">
      <div class="track-title">${title}</div>
      <div class="track-artist">${artist}</div>
      <div class="track-time text-secondary" style="font-size:0.85rem;">
        0:00 / 0:00
      </div>
    </div>
    <button class="btn btn-sm btn-outline-light ms-auto play-btn">▶</button>
  `;

  const playBtn = card.querySelector(".play-btn");
  const timeLabel = card.querySelector(".track-time");

  playBtn.addEventListener("click", () => {

    // SAME TRACK → toggle play/pause
    if (currentTrack === file) {
      wavesurfer.playPause();
      updatePlayButton(playBtn);
      return;
    }

    // NEW TRACK
    resetAllButtons();
    removeHighlight();

    currentTrack = file;
    currentButton = playBtn;
    currentCard = card;

    highlightCard(card);

    wavesurfer.load(file);

    wavesurfer.once("ready", () => {
      wavesurfer.play();
      playBtn.textContent = "⏸";

      // show duration once loaded
      const duration = formatTime(wavesurfer.getDuration());
      timeLabel.textContent = `0:00 / ${duration}`;
    });

    // Update mini player
    miniTitle.innerText = title;
    miniArtist.innerText = artist;
    miniArtwork.src = imageUrl || "";
    miniPlayer.style.display = "block";
  });

  // Update time counter while playing
  wavesurfer.on("audioprocess", () => {
    if (currentTrack !== file) return;

    const current = formatTime(wavesurfer.getCurrentTime());
    const duration = formatTime(wavesurfer.getDuration());
    timeLabel.textContent = `${current} / ${duration}`;
  });

  trackList.appendChild(card);
}


function resetAllButtons() {
  document.querySelectorAll(".play-btn").forEach(btn => {
    btn.textContent = "▶";
  });
}

function updatePlayButton(btn) {
  if (wavesurfer.isPlaying()) {
    btn.textContent = "⏸";
  } else {
    btn.textContent = "▶";
  }
}

function highlightCard(card) {
  card.style.background = "#2a2a2a";
}

function removeHighlight() {
  document.querySelectorAll(".track-card").forEach(card => {
    card.style.background = "#1e1e1e";
  });
}

function formatTime(sec) {
  if (!sec) return "0:00";
  const minutes = Math.floor(sec / 60);
  const seconds = Math.floor(sec % 60).toString().padStart(2, "0");
  return `${minutes}:${seconds}`;
}

// Reset UI when track ends
wavesurfer.on("finish", () => {
  resetAllButtons();
  removeHighlight();
  currentTrack = null;
});

</script>

</body>
</html>
